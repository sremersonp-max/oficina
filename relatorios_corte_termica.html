// =============================================================================
// GERAÇÃO DE ARQUIVO TXT PARA IMPRESSORA TÉRMICA 55mm
// =============================================================================
function gerarArquivoTextoCorte() {
    if (produtosOrcamento.length === 0) {
        alert('❌ Adicione produtos ao orçamento primeiro.');
        return;
    }
    
    const orcamentoSimulado = {
        id: editandoOrcamentoId || 'NOVO',
        cliente: document.getElementById('nomeCliente').value,
        localizacao: document.getElementById('localizacaoObra').value,
        data: document.getElementById('dataOrcamento').value,
        produtos: produtosOrcamento,
    };

    // *** AVISO: SUBSTITUA ESTA FUNÇÃO PELA VERSÃO REAL DO folha_corte.html ***
    const dadosCorte = simularGerarFolhaDeCorte(orcamentoSimulado); 
    
    // --- CONFIGURAÇÕES PARA 55mm ---
    const LARGURA_MAXIMA = 32; // Caracteres para 55mm
    
    // --- GERAÇÃO DO CONTEÚDO TXT PARA 55mm ---
    let outputText = '';
    
    // Cabeçalho otimizado para 55mm
    outputText += pad("", LARGURA_MAXIMA, 'center', '=') + "\n";
    outputText += pad("LISTA DE CORTES", LARGURA_MAXIMA, 'center') + "\n";
    outputText += pad("OFICINA DA FAMILIA", LARGURA_MAXIMA, 'center') + "\n";
    outputText += pad("", LARGURA_MAXIMA, 'center', '=') + "\n\n";

    // Informações do cliente (otimizadas para 55mm)
    outputText += "CLI: " + (orcamentoSimulado.cliente || '---').substring(0, 28).toUpperCase() + "\n";
    outputText += "LOC: " + (orcamentoSimulado.localizacao || '---').substring(0, 28).toUpperCase() + "\n";
    outputText += "ORC: " + orcamentoSimulado.id + "\n";
    outputText += "DATA: " + (orcamentoSimulado.data || new Date().toLocaleDateString('pt-BR')) + "\n";
    outputText += pad("", LARGURA_MAXIMA, 'center', '-') + "\n";
    
    const chavesPerfil = Array.from(dadosCorte.keys()).sort();
    
    if (chavesPerfil.length === 0) {
        outputText += pad("NENHUM CORTE", LARGURA_MAXIMA, 'center') + "\n";
    } else {
        // Cabeçalho da tabela otimizado
        outputText += "QTD X MEDIDA (MM)\n";
        outputText += pad("", LARGURA_MAXIMA, 'center', '-') + "\n";

        chavesPerfil.forEach(chave => {
            const cortesDoPerfil = dadosCorte.get(chave);
            const [nomePerfil, cor] = chave.split(' | ');
            
            // Nome do perfil otimizado para 55mm
            const perfilFormatado = (nomePerfil + ' - ' + cor).substring(0, 30).toUpperCase();
            outputText += "\n" + perfilFormatado + "\n";
            outputText += pad("", perfilFormatado.length, 'center', '~') + "\n";
            
            // Lista de cortes
            cortesDoPerfil.forEach(corte => {
                const medidaStr = corte.medida_mm.toString();
                const qtdStr = corte.quantidade.toString();

                // Formato compacto: [QTD]x[MEDIDA]mm
                const linhaCorte = pad(qtdStr, 3, 'right') + " x " + pad(medidaStr, 4, 'right') + "mm";
                outputText += linhaCorte + "\n";
            });
            
            outputText += "\n";
        });
    }

    outputText += pad("", LARGURA_MAXIMA, 'center', '=') + "\n";
    outputText += pad("FIM DO RELATORIO", LARGURA_MAXIMA, 'center') + "\n";
    outputText += pad("", LARGURA_MAXIMA, 'center', '=') + "\n";
    
    // --- DOWNLOAD DO ARQUIVO ---
    const filename = `CORTES_55mm_${orcamentoSimulado.id}.txt`;
    const blob = new Blob([outputText], { type: 'text/plain;charset=utf-8' });
    
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    alert(`✅ Arquivo ${filename} gerado para 55mm!`);
}

// FUNÇÃO AUXILIAR ATUALIZADA PARA 55mm
function pad(str, len, align = 'right', char = ' ') {
    str = String(str);
    if (str.length >= len) return str.substring(0, len);
    
    const padding = char.repeat(len - str.length);
    
    switch(align) {
        case 'left':
            return str + padding;
        case 'center':
            const leftPadding = char.repeat(Math.floor((len - str.length) / 2));
            const rightPadding = char.repeat(len - str.length - leftPadding.length);
            return leftPadding + str + rightPadding;
        default: // right
            return padding + str;
    }
}

// ⚠️ FUNÇÃO TEMPORÁRIA - SUBSTITUIR PELA VERSÃO REAL DO folha_corte.html
function simularGerarFolhaDeCorte(orcamento) {
    console.warn("⚠️ USANDO LÓGICA SIMULADA - Substitua pelas funções reais do folha_corte.html");
    const cortesSimulados = new Map();
    
    orcamento.produtos.forEach(prod => {
        if (!prod.isAvulso) {
            const nome = "PERFIL TESTE";
            cortesSimulados.set(`${nome} | BRANCO`, [
                { medida_mm: 1200, quantidade: prod.quantidade * 2, origens: [] },
                { medida_mm: 850, quantidade: prod.quantidade * 4, origens: [] }
            ]);
        }
    });
    return cortesSimulados;
}