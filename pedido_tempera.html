<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pedidos de Vidros para Tempera - F√≥rmulas Espec√≠ficas</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); color: white; padding: 25px 30px; text-align: center; }
        .header h1 { font-size: 28px; margin-bottom: 10px; }
        .content { padding: 30px; }
        .card { background: #f8f9fa; border-radius: 10px; padding: 25px; margin-bottom: 25px; border-left: 4px solid #3498db; }
        .btn { padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 8px; margin: 5px; }
        .btn-primary { background: #3498db; color: white; }
        .btn-success { background: #27ae60; color: white; }
        .btn-info { background: #17a2b8; color: white; }
        .btn-warning { background: #f39c12; color: white; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 15px; transition: border-color 0.3s ease; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #3498db; }
        .grid { display: grid; gap: 20px; }
        .grid-2 { grid-template-columns: 1fr 1fr; }
        .grid-3 { grid-template-columns: 1fr 1fr 1fr; }
        .grid-4 { grid-template-columns: 1fr 1fr 1fr 1fr; }
        
        .produto-tempera-card { background: white; border-radius: 10px; padding: 20px; margin-bottom: 20px; border-left: 4px solid #f39c12; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .produto-header { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 15px; align-items: end; margin-bottom: 15px; }
        .vidro-info { background: #e8f4f8; padding: 15px; border-radius: 8px; margin-top: 10px; border-left: 3px solid #17a2b8; }
        .folha-info { background: #f8f9fa; padding: 8px 12px; margin: 5px 0; border-radius: 4px; border-left: 2px solid #3498db; }
        .tabela-vidros { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .tabela-vidros th { background: #34495e; color: white; padding: 15px; text-align: left; font-weight: 600; }
        .tabela-vidros td { padding: 12px 15px; border-bottom: 1px solid #f0f0f0; }
        .tabela-vidros tr:hover { background: #f8f9fa; }
        .total-section { background: #2c3e50; color: white; padding: 20px; border-radius: 10px; margin-top: 20px; text-align: center; }
        .total-geral { font-size: 24px; font-weight: bold; color: #27ae60; margin-top: 10px; }
        .loading { text-align: center; padding: 40px; color: #7f8c8d; }
        .hidden { display: none; }
        .error { color: #e74c3c; background: #fde8e8; padding: 10px; border-radius: 5px; }
        .success { color: #27ae60; background: #e8f8ef; padding: 10px; border-radius: 5px; }
        .badge-formula { background: #6c757d; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.7em; margin-left: 8px; cursor: help; }
        
        /* --- ESTILOS PARA O PREVIEW DA IMAGEM --- */
        .preview-desenho-tempera {
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }
        .svg-preview-tempera {
            width: 100%;
            height: 120px;
            border: 1px solid #ccc;
            background: white;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        .svg-preview-tempera img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        @media (max-width: 768px) {
            .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; }
            .produto-header { grid-template-columns: 1fr; gap: 10px; }
            .content { padding: 20px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç Pedidos de Vidros para Tempera - F√≥rmulas Espec√≠ficas</h1>
            <p>Sistema que usa as f√≥rmulas cadastradas em cada produto</p>
        </div>
	
	<div class="header">
            <h1>üè≠ Sistema de Or√ßamentos - Esquadrias</h1>
            <a href="comeco.html" class="btn btn-secondary" style="margin-top: 15px;">‚¨ÖÔ∏è Voltar ao In√≠cio</a>
        </div>
        <div class="content">
            <div class="card">
                <h2>üèóÔ∏è Selecionar Obra para Calcular Vidros</h2>
                <div class="grid grid-3">
                    <div class="form-group">
                        <label for="selecionarObra">Selecionar Obra Aprovada</label>
                        <select id="selecionarObra" onchange="carregarProdutosObra()">
                            <option value="">Carregando obras...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="clienteObra">Cliente</label>
                        <input type="text" id="clienteObra" readonly>
                    </div>
                    <div class="form-group">
                        <label for="localizacaoObra">Localiza√ß√£o</label>
                        <input type="text" id="localizacaoObra" readonly>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>‚öôÔ∏è Configura√ß√µes do Pedido</h2>
                <div class="grid grid-3">
                    <div class="form-group">
                        <label for="dataPedido">Data do Pedido</label>
                        <input type="text" id="dataPedido" readonly>
                    </div>
                    <div class="form-group">
                        <label for="fornecedorVidro">Fornecedor de Vidros</label>
                        <select id="fornecedorVidro">
                            <option value="Temperforte">Temperforte</option>
                            <option value="Unoglass">Unoglass</option>
                           
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="tipoVidro">Tipo de Vidro</label>
                        <select id="tipoVidro">
                         
                        </select>
                    </div>
                </div>
                
                <div class="grid grid-2">
                    <div class="form-group">
                        <label for="observacoesTempera">Observa√ß√µes</label>
                        <textarea id="observacoesTempera" rows="3" placeholder="Observa√ß√µes para o fornecedor..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="margemAdicional">Margem Adicional (cm)</label>
                        <input type="number" id="margemAdicional" value="0.0" step="0.1" min="0">
                        <small style="color: #666;">Margem extra para aplicar em todas as f√≥rmulas (opcional)</small>
                    </div>
                </div>
            </div>

            <div class="card" id="cardProdutosObra" style="display: none;">
                <h2>üìã Produtos da Obra Selecionada</h2>
                <div id="infoObra" style="background: #e8f4f8; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <strong id="infoCliente"></strong><br>
                    <small id="infoLocalizacao"></small>
                </div>
                
                <div id="listaProdutosObra">
                    <div class="loading">Carregando produtos da obra...</div>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-warning" onclick="calcularTodosVidrosObra()">
                        üßÆ Calcular Todos os Vidros da Obra
                    </button>
                </div>
            </div>

            <div class="card" id="resumoVidros" style="display: none;">
                <h2>üìä Resumo dos Vidros para Tempera</h2>
                
                <div id="tabelaResumoVidros">
                    <table class="tabela-vidros">
                        <thead>
                            <tr>
                                <th>Produto</th>
                                <th>Pe√ßa</th>
                                <th>F√≥rmula</th>
                                <th>Medidas Vidro</th>
                                <th>Quantidade</th>
                                <th>√Årea (m¬≤)</th>
                            </tr>
                        </thead>
                        <tbody id="corpoTabelaVidros">
                        </tbody>
                    </table>
                </div>
                
                <div class="total-section">
                    <h3>üì¶ Resumo Geral da Obra</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-top: 15px;">
                        <div>Total de Produtos: <span id="totalProdutosVidro">0</span></div>
                        <div>Total de Vidros: <span id="totalVidros">0</span></div>
                        <div>√Årea Total: <span id="areaTotal">0 m¬≤</span></div>
                    </div>
                    <div class="total-geral" id="totalGeralVidros">√Årea Total: 0 m¬≤</div>
                </div>

                <div class="acoes" style="display: flex; gap: 15px; justify-content: center; margin-top: 25px; flex-wrap: wrap;">
                    <button class="btn btn-success" id="btnGerarPDF" onclick="gerarPDFTempera()">
                        üìÑ Gerar PDF para Tempera
                    </button>
                    <button class="btn btn-info" onclick="gerarPlanilha()">
                        üìä Exportar para Excel
                    </button>
                    <button class="btn btn-primary" onclick="limparPedido()">
                        üÜï Novo Pedido
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        // =============================================================================
        // VARI√ÅVEIS GLOBAIS
        // =============================================================================
        let obrasAprovadas = [];
        let produtosObra = [];
        let vidrosCalculados = [];
        let produtosCadastrados = [];
        let formulasPorProduto = {};
        let variacoesCompletas = [];
        let coresCompletas = [];

        // =============================================================================
        // INICIALIZA√á√ÉO
        // =============================================================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîç Iniciando sistema de pedidos para tempera...');
            atualizarData();
            
            try {
                await carregarObrasAprovadas();
                await carregarTodosProdutosBase();
                console.log('‚úÖ Sistema de tempera pronto!');
            } catch (error) {
                console.error('‚ùå Erro na inicializa√ß√£o:', error);
                alert('Erro ao carregar dados: ' + error.message);
            }
        });

        function atualizarData() {
            const now = new Date();
            const dataFormatada = now.toLocaleDateString('pt-BR');
            document.getElementById('dataPedido').value = dataFormatada;
        }

        // =============================================================================
        // CARREGAMENTO DE DADOS
        // =============================================================================
        async function carregarObrasAprovadas() {
            try {
                const { data, error } = await supabase
                    .from('orcamentos')
                    .select('id, cliente, localizacao, data, status')
                    .eq('status', 'aprovado')
                    .order('data', { ascending: false });

                if (error) throw error;
                
                obrasAprovadas = data || [];
                atualizarSelectObras();
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar obras aprovadas:', error);
                document.getElementById('selecionarObra').innerHTML = '<option value="">Erro ao carregar obras</option>';
            }
        }
        
        async function carregarTodosProdutosBase() {
             try {
                const { data, error } = await supabase
                    .from('produtos')
                    .select('id, nome');
                
                if (error) throw error;
                produtosCadastrados = data || [];
                console.log('‚úÖ Nomes de produtos base carregados.');
            } catch (error) {
                console.error('‚ùå Erro ao carregar nomes de produtos:', error);
            }
        }

        function atualizarSelectObras() {
            const select = document.getElementById('selecionarObra');
            select.innerHTML = '<option value="">Selecione uma obra...</option>';
            
            obrasAprovadas.forEach(obra => {
                const dataFormatada = formatarData(obra.data);
                select.innerHTML += `<option value="${obra.id}">${obra.cliente} - ${obra.localizacao || 'Sem local'} (${dataFormatada})</option>`;
            });
        }

        function formatarData(data) {
            if (!data) return 'Data inv√°lida';
            if (data.includes('/')) return data;
            if (data.includes('-')) {
                const [ano, mes, dia] = data.split('T')[0].split('-');
                return `${dia}/${mes}/${ano}`;
            }
            return data;
        }

        // =============================================================================
        // CARREGAMENTO DE PRODUTOS DA OBRA COM VIDROS SELECIONADOS
        // =============================================================================
        async function carregarProdutosObra() {
            const obraId = document.getElementById('selecionarObra').value;
            if (!obraId) return;

            try {
                const { data, error } = await supabase
                    .from('orcamentos')
                    .select('*')
                    .eq('id', obraId)
                    .single();

                if (error) throw error;

                document.getElementById('clienteObra').value = data.cliente || '';
                document.getElementById('localizacaoObra').value = data.localizacao || '';
                document.getElementById('infoCliente').textContent = `Cliente: ${data.cliente}`;
                document.getElementById('infoLocalizacao').textContent = `Local: ${data.localizacao || 'N√£o informado'}`;
                
                produtosObra = data.produtos || [];
                
                // CARREGAR DADOS ADICIONAIS PARA OBTER AS CORES DOS VIDROS
                await carregarDadosAdicionaisParaVidros();
                await carregarFormulasParaProdutosObra();
                
                renderizarProdutosObra();
                document.getElementById('cardProdutosObra').style.display = 'block';
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar produtos da obra:', error);
                alert('Erro ao carregar obra: ' + error.message);
            }
        }

        // =============================================================================
        // CARREGAR DADOS ADICIONAIS PARA OBTER CORES DOS VIDROS
        // =============================================================================
        async function carregarDadosAdicionaisParaVidros() {
            try {
                // Carregar varia√ß√µes e cores para identificar os vidros selecionados
                const [variacoesRes, coresRes] = await Promise.all([
                    supabase.from('item_variacoes').select('*, cores(nome), itens(nome, categorias(nome))'),
                    supabase.from('cores').select('*')
                ]);

                if (variacoesRes.error) throw variacoesRes.error;
                if (coresRes.error) throw coresRes.error;

                variacoesCompletas = variacoesRes.data || [];
                coresCompletas = coresRes.data || [];
                
                console.log('‚úÖ Dados de varia√ß√µes carregados para vidros:', variacoesCompletas.length);
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar dados adicionais:', error);
                variacoesCompletas = [];
                coresCompletas = [];
            }
        }

        // =============================================================================
        // CARREGAMENTO DE F√ìRMULAS
        // =============================================================================
        async function carregarFormulasParaProdutosObra() {
            formulasPorProduto = {};
            
            const produtosComId = produtosObra.filter(p => !p.isAvulso && p.produtoId);
            if (produtosComId.length === 0) return;
            
            const produtoIds = [...new Set(produtosComId.map(p => p.produtoId))];
            
            try {
                const { data, error } = await supabase
                    .from('produto_vidros')
                    .select('*') 
                    .in('produto_id', produtoIds)
                    .order('ordem');
                
                if (error) throw error;
                
                if (data && data.length > 0) {
                    data.forEach(formula => {
                        if (!formulasPorProduto[formula.produto_id]) {
                            formulasPorProduto[formula.produto_id] = [];
                        }
                        formulasPorProduto[formula.produto_id].push(formula);
                    });
                }
                
                console.log('‚úÖ F√≥rmulas (com visualiza√ß√£o) carregadas:', Object.keys(formulasPorProduto).length);
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar f√≥rmulas:', error);
            }
        }
        
        function gerarSVGGeralComImagensModal(formulas) {
            if (!formulas || formulas.length === 0) {
                 return '<div style="text-align: center; padding: 40px; color: #666;">Sem visualiza√ß√£o</div>';
            }
            
            let pecasParaRenderizar = [];
            
            // Expande as pe√ßas baseado na quantidade (tamb√©m no modal)
            formulas.forEach((formula, index) => {
                for (let i = 0; i < (formula.quantidade_pecas || 1); i++) {
                    pecasParaRenderizar.push({
                        ...formula,
                        posicao_x: formula.posicao_x + (i * 5),
                        posicao_y: formula.posicao_y + (i * 3),
                        indiceMultipla: i + 1
                    });
                }
            });

            return `
                <svg width="100%" height="100%" viewBox="0 0 200 150">
                    <rect x="10" y="10" width="180" height="130" fill="none" stroke="#333" stroke-width="2"/>
                    ${pecasParaRenderizar.map((formula, index) => {
                        const x = (formula.posicao_x || 0) + 15;
                        const y = (formula.posicao_y || 0) + 15;
                        const width = formula.largura_svg || 50;
                        const height = formula.altura_svg || 50;
                        const textoIndice = formula.quantidade_pecas > 1 ? `${index + 1}.${formula.indiceMultipla}` : (index + 1);

                        if (formula.url_imagem_peca) {
                            return `
                                <image href="${formula.url_imagem_peca}" 
                                       x="${x}" y="${y}" 
                                       width="${width}" height="${height}"
                                       preserveAspectRatio="xMidYMid meet"/>
                                <text x="${x + width/2}" y="${y + height/2}" font-size="8" text-anchor="middle" dominant-baseline="middle"
                                      fill="#000" font-weight="bold" stroke="#fff" stroke-width="0.5">
                                    ${textoIndice}
                                </text>
                            `;
                        } else {
                            return `
                                <rect x="${x}" y="${y}" width="${width}" height="${height}"
                                      fill="${formula.cor_indicativa || '#3498db'}40" stroke="${formula.cor_indicativa || '#3498db'}" stroke-width="1.5" rx="2"/>
                                <text x="${x + width/2}" y="${y + height/2}" font-size="8" text-anchor="middle" dominant-baseline="middle"
                                      fill="#2c3e50" font-weight="bold">
                                    ${textoIndice}
                                </text>
                            `;
                        }
                    }).join('')}
                    <text x="100" y="145" font-size="10" text-anchor="middle" fill="#666">
                        Visualiza√ß√£o: ${pecasParaRenderizar.length} pe√ßa(s) total
                    </text>
                </svg>
            `;
        }

        // =============================================================================
        // RENDERIZA√á√ÉO DOS PRODUTOS
        // =============================================================================
        function renderizarProdutosObra() {
            const container = document.getElementById('listaProdutosObra');
            
            if (produtosObra.length === 0) {
                container.innerHTML = '<div class="loading">Nenhum produto encontrado nesta obra</div>';
                return;
            }

            container.innerHTML = produtosObra.map(produto => {
                const produtoInfo = obterInfoProduto(produto);
                const temFormulas = produtoInfo.temFormulas;
                const quantidadeFormulas = produtoInfo.quantidadeFormulas;
                const formulas = formulasPorProduto[produto.produtoId] || [];
                const totalPecas = formulas.reduce((sum, f) => sum + (f.quantidade_pecas || 1), 0);
                const previewHtml = temFormulas ? gerarSVGGeralComImagensModal(formulas) : '';

                return `
                    <div class="produto-tempera-card" id="produto_${produto.id}">
                        <div class="produto-header">
                            <div class="form-group">
                                <label>Produto</label>
                                <p style="font-weight: bold; margin: 0; font-size: 16px;">${produtoInfo.nome}</p>
                                <small style="color: #666;">
                                    ${temFormulas ? 
                                        `<span class="badge-formula" title="${quantidadeFormulas} f√≥rmula(s) cadastrada(s)">üìê ${quantidadeFormulas} f√≥rmula(s)</span>` : 
                                        '<span style="color: #e74c3c;">‚ùå Sem f√≥rmulas de vidro</span>'}
                                    ${temFormulas ? `<br><small>Total de pe√ßas: ${totalPecas}</small>` : ''}
                                </small>
                            </div>
                            <div class="form-group">
                                <label>Largura (m)</label>
                                <input type="number" id="largura_${produto.id}" 
                                       value="${produto.largura || ''}" 
                                       placeholder="1.20" min="0.1" step="0.01" 
                                       onchange="calcularVidroProduto('${produto.id}')">
                            </div>
                            <div class="form-group">
                                <label>Altura (m)</label>
                                <input type="number" id="altura_${produto.id}" 
                                       value="${produto.altura || ''}" 
                                       placeholder="2.00" min="0.1" step="0.01"
                                       onchange="calcularVidroProduto('${produto.id}')">
                            </div>
                            <div class="form-group">
                                <label>Quantidade</label>
                                <input type="number" id="quantidade_${produto.id}" 
                                       value="${produto.quantidade || 1}" min="1"
                                       onchange="calcularVidroProduto('${produto.id}')">
                            </div>
                            <button class="btn btn-info" onclick="calcularVidroProduto('${produto.id}')" 
                                    ${!temFormulas ? 'disabled title="Produto sem f√≥rmulas de vidro cadastradas"' : ''}>
                                üßÆ Calcular
                            </button>
                        </div>
                        
                        ${temFormulas ? `
                            <div class="preview-desenho-tempera">
                                <div class="svg-preview-tempera">
                                    ${previewHtml}
                                </div>
                            </div>
                        ` : ''}
                        
                        <div id="resultado_${produto.id}" class="vidro-info hidden">
                            </div>
                    </div>
                `;
            }).join('');
        }

        // =============================================================================
        // FUN√á√ïES AUXILIARES
        // =============================================================================
        function obterInfoProduto(produto) {
            if (produto.isAvulso) {
                return {
                    nome: produto.nomeAvulso || 'Item Avulso',
                    temFormulas: false,
                    quantidadeFormulas: 0
                };
            } else {
                const produtoBase = produtosCadastrados.find(p => p.id == produto.produtoId);
                const nomeProduto = produtoBase ? produtoBase.nome : `Produto ID: ${produto.produtoId}`;
                
                const formulas = formulasPorProduto[produto.produtoId] || [];
                return {
                    nome: nomeProduto,
                    temFormulas: formulas.length > 0,
                    quantidadeFormulas: formulas.length
                };
            }
        }

        // =============================================================================
        // C√ÅLCULO DE VIDROS COM CORES DO OR√áAMENTO
        // =============================================================================
        function calcularVidroProduto(produtoId) {
            const produto = produtosObra.find(p => p.id === produtoId);
            if (!produto) return;

            const produtoInfo = obterInfoProduto(produto);
            const larguraJanela = parseFloat(document.getElementById(`largura_${produtoId}`).value) || 0;
            const alturaJanela = parseFloat(document.getElementById(`altura_${produtoId}`).value) || 0;
            const quantidade = parseInt(document.getElementById(`quantidade_${produtoId}`).value) || 1;
            const margemAdicional = parseFloat(document.getElementById('margemAdicional').value) || 0;

            if (larguraJanela <= 0 || alturaJanela <= 0) {
                document.getElementById(`resultado_${produtoId}`).innerHTML = `
                    <div class="error">
                        ‚ùå Informe largura e altura v√°lidas
                    </div>
                `;
                return;
            }

            if (!produtoInfo.temFormulas) {
                document.getElementById(`resultado_${produtoId}`).innerHTML = `
                    <div class="error">
                        ‚ùå Este produto n√£o tem f√≥rmulas de vidro cadastradas
                    </div>
                `;
                return;
            }

            const formulas = formulasPorProduto[produto.produtoId] || [];
            
            let resultadosHTML = `<div class="success">‚úÖ ${formulas.length} pe√ßa(s) de vidro calculada(s)</div>`;
            let vidrosProduto = [];

            formulas.forEach((formula, index) => {
                const larguraVidro = calcularFormula(formula.formula_largura, larguraJanela, alturaJanela, margemAdicional);
                const alturaVidro = calcularFormula(formula.formula_altura, larguraJanela, alturaJanela, margemAdicional);
                
                const areaVidro = larguraVidro * alturaVidro;
                const quantidadeTotal = quantidade * (formula.quantidade_pecas || 1);

                // =========================================================================
                // BUSCAR A COR DO VIDRO SELECIONADA NO OR√áAMENTO
                // =========================================================================
                let corVidro = 'Padr√£o';
                let tipoVidroInfo = '';
                
                if (produto.substituicoes) {
                    // Procurar qual item de vidro foi substitu√≠do neste produto
                    Object.entries(produto.substituicoes).forEach(([itemPaiId, variacaoId]) => {
                        const variacao = variacoesCompletas.find(v => v.id == variacaoId);
                        if (variacao) {
                            // Verificar se esta varia√ß√£o √© um vidro
                            const isVidro = variacao.itens?.nome?.toLowerCase().includes('vidro') || 
                                           variacao.itens?.categorias?.nome?.toLowerCase().includes('vidro');
                            
                            if (isVidro) {
                                corVidro = variacao.cores?.nome || 'Cor n√£o identificada';
                                tipoVidroInfo = variacao.itens?.nome || 'Vidro';
                            }
                        }
                    });
                }

                const imgPreview = formula.url_imagem_peca ? 
                    `<img src="${formula.url_imagem_peca}" style="width: 40px; height: 40px; object-fit: contain; border: 1px solid #ccc; background: white; margin-right: 10px; border-radius: 4px;">` : 
                    '';

                resultadosHTML += `
                    <div class="folha-info" style="display: flex; align-items: center;">
                        ${imgPreview}
                        <div>
                            <strong>${formula.nome_peca}</strong>
                            <div style="font-size: 14px; color: #666;">
                                <strong style="color: #e74c3c;">${tipoVidroInfo} ${corVidro}</strong><br>
                                F√≥rmula: ${formula.formula_largura} √ó ${formula.formula_altura}<br>
                                Medidas: ${larguraVidro.toFixed(3)}m √ó ${alturaVidro.toFixed(3)}m<br>
                                √Årea: ${areaVidro.toFixed(3)}m¬≤ ‚Ä¢ Quantidade: ${quantidadeTotal}
                                ${formula.quantidade_pecas > 1 ? `<br><small>(${quantidade} produto √ó ${formula.quantidade_pecas} pe√ßas)</small>` : ''}
                                ${formula.descricao ? `<br><small>${formula.descricao}</small>` : ''}
                            </div>
                        </div>
                    </div>
                `;

                vidrosProduto.push({
                    produtoId: produtoId,
                    produtoNome: produtoInfo.nome,
                    pecaNome: formula.nome_peca,
                    formulaLargura: formula.formula_largura,
                    formulaAltura: formula.formula_altura,
                    descricao: formula.descricao,
                    larguraJanela: larguraJanela,
                    alturaJanela: alturaJanela,
                    larguraVidro: larguraVidro,
                    alturaVidro: alturaVidro,
                    quantidadeProduto: quantidade,
                    quantidadePecas: formula.quantidade_pecas || 1,
                    quantidadeTotal: quantidadeTotal,
                    areaUnitario: areaVidro,
                    areaTotal: areaVidro * quantidadeTotal,
                    url_imagem_peca: formula.url_imagem_peca,
                    // NOVOS CAMPOS: Informa√ß√µes do vidro selecionado no or√ßamento
                    corVidro: corVidro,
                    tipoVidro: tipoVidroInfo
                });
            });

            const resultadoDiv = document.getElementById(`resultado_${produtoId}`);
            resultadoDiv.innerHTML = resultadosHTML;
            resultadoDiv.classList.remove('hidden');

            vidrosCalculados = vidrosCalculados.filter(v => v.produtoId !== produtoId);
            vidrosCalculados.push(...vidrosProduto);

            atualizarResumoVidros();
        }

        // =============================================================================
        // FUN√á√ÉO PARA CALCULAR F√ìRMULAS
        // =============================================================================
        function calcularFormula(formula, L, A, margemAdicional = 0) {
            let expressao = formula.toLowerCase().replace(/\s/g, '');
            
            expressao = expressao.replace(/l/g, L.toString());
            expressao = expressao.replace(/a/g, A.toString());
            
            if (margemAdicional > 0) {
                if (expressao.includes('-')) {
                    expressao = `(${expressao}) - ${margemAdicional/100}`;
                }
            }
            
            try {
                const resultado = new Function(`return ${expressao}`)();
                return Math.max(0, parseFloat(resultado) || 0);
            } catch (error) {
                console.error(`Erro ao calcular f√≥rmula "${formula}":`, error);
                return 0;
            }
        }

        // =============================================================================
        // C√ÅLCULO EM LOTE
        // =============================================================================
        function calcularTodosVidrosObra() {
            const produtos = document.querySelectorAll('[id^="produto_"]');
            let calculados = 0;
            let semFormulas = 0;
            let comErro = 0;
            
            produtos.forEach(produtoCard => {
                const produtoId = produtoCard.id.replace('produto_', '');
                const produto = produtosObra.find(p => p.id === produtoId);
                const produtoInfo = obterInfoProduto(produto);
                const largura = parseFloat(document.getElementById(`largura_${produtoId}`).value) || 0;
                const altura = parseFloat(document.getElementById(`altura_${produtoId}`).value) || 0;
                
                if (largura > 0 && altura > 0) {
                    if (produtoInfo.temFormulas) {
                        calcularVidroProduto(produtoId);
                        calculados++;
                    } else {
                        semFormulas++;
                    }
                } else {
                    comErro++;
                }
            });
            
            let mensagem = '';
            if (calculados > 0) mensagem += `üßÆ ${calculados} produtos calculados!`;
            if (semFormulas > 0) mensagem += ` ${semFormulas} sem f√≥rmulas de vidro.`;
            if (comErro > 0) mensagem += ` ${comErro} com dados incompletos.`;
            
            if (mensagem) {
                alert(mensagem);
            } else {
                alert('‚ùå Preencha as medidas dos produtos primeiro');
            }
        }

        // =============================================================================
        // ATUALIZA√á√ÉO DO RESUMO COM CORES DOS VIDROS
        // =============================================================================
        function atualizarResumoVidros() {
            if (vidrosCalculados.length === 0) {
                document.getElementById('resumoVidros').style.display = 'none';
                return;
            }

            document.getElementById('resumoVidros').style.display = 'block';
            
            const tabelaBody = document.getElementById('corpoTabelaVidros');
            
            let html = '';
            let totalVidros = 0;
            let areaTotal = 0;
            const produtosProcessados = new Set();

            vidrosCalculados.forEach(vidro => {
                html += `
                    <tr>
                        <td><strong>${vidro.produtoNome}</strong></td>
                        <td>
                            ${vidro.pecaNome}
                            ${vidro.corVidro !== 'Padr√£o' ? `<br><small style="color: #e74c3c;">${vidro.tipoVidro} ${vidro.corVidro}</small>` : ''}
                        </td>
                        <td><small>${vidro.formulaLargura} √ó ${vidro.formulaAltura}</small></td>
                        <td>${vidro.larguraVidro.toFixed(3)}m √ó ${vidro.alturaVidro.toFixed(3)}m</td>
                        <td>${vidro.quantidadeTotal}</td>
                        <td>${vidro.areaTotal.toFixed(3)}m¬≤</td>
                    </tr>
                `;
                
                totalVidros += vidro.quantidadeTotal;
                areaTotal += vidro.areaTotal;
                produtosProcessados.add(vidro.produtoId);
            });

            tabelaBody.innerHTML = html;
            
            document.getElementById('totalProdutosVidro').textContent = produtosProcessados.size;
            document.getElementById('totalVidros').textContent = totalVidros;
            document.getElementById('areaTotal').textContent = areaTotal.toFixed(3);
            document.getElementById('totalGeralVidros').textContent = `√Årea Total: ${areaTotal.toFixed(3)} m¬≤ (${totalVidros} vidros)`;
        }

        // =============================================================================
        // GERA√á√ÉO DE RELAT√ìRIOS COM IMAGENS NO PDF - VERS√ÉO PROFISSIONAL
        // =============================================================================
        async function gerarPDFTempera() {
            if (vidrosCalculados.length === 0) {
                alert('‚ùå Calcule os vidros primeiro');
                return;
            }

            const { jsPDF } = window.jspdf;
            if (!jsPDF) {
                alert('‚ùå Biblioteca PDF n√£o carregada');
                return;
            }

            const doc = new jsPDF();
            const fornecedor = document.getElementById('fornecedorVidro').value;
            const tipoVidro = document.getElementById('tipoVidro').value;
            const observacoes = document.getElementById('observacoesTempera').value;
            const dataPedido = document.getElementById('dataPedido').value;
            const cliente = document.getElementById('clienteObra').value;
            const localizacao = document.getElementById('localizacaoObra').value;

            // =========================================================================
            // CABE√áALHO PROFISSIONAL
            // =========================================================================
            
            // Cores da empresa
            const corPrimaria = [44, 62, 80];   // Azul escuro
            const corSecundaria = [52, 152, 219]; // Azul
            const corDestaque = [231, 76, 60];   // Vermelho

            // Cabe√ßalho com logo e informa√ß√µes da empresa
            doc.setFillColor(...corPrimaria);
            doc.rect(0, 0, 210, 40, 'F');
            
            // Logo/Nome da empresa
            doc.setFontSize(20);
            doc.setTextColor(255, 255, 255);
            doc.setFont(undefined, 'bold');
            doc.text('OFICINA DA FAM√çLIA', 105, 15, { align: 'center' });
            
            doc.setFontSize(10);
            doc.setTextColor(200, 200, 200);
            doc.setFont(undefined, 'normal');
            doc.text('Esquadrias e Servi√ßos em Alum√≠nio', 105, 22, { align: 'center' });
            
            // Informa√ß√µes de contato
            doc.setFontSize(8);
            doc.text('Rua Elias Calisto, 669 - Ipiranga - PR', 20, 32);
            doc.text('CEP: 84450-000 | Tel: (42) 99960-8330', 20, 36);
            
            doc.text(`Pedido: ${dataPedido}`, 190, 32, { align: 'right' });
            doc.text('P√°gina 1 de 1', 190, 36, { align: 'right' });

            // =========================================================================
            // T√çTULO DO DOCUMENTO
            // =========================================================================
            doc.setFontSize(16);
            doc.setTextColor(...corPrimaria);
            doc.setFont(undefined, 'bold');
            doc.text('PEDIDO DE VIDROS PARA TEMPERA', 105, 55, { align: 'center' });

            // =========================================================================
            // INFORMA√á√ïES DA OBRA E CLIENTE
            // =========================================================================
            let currentY = 70;

            // Linha divis√≥ria
            doc.setDrawColor(...corSecundaria);
            doc.line(20, currentY - 5, 190, currentY - 5);
            
            doc.setFontSize(11);
            doc.setTextColor(0, 0, 0);
            doc.setFont(undefined, 'bold');
            doc.text('DADOS DO CLIENTE:', 20, currentY);
            
            doc.setFont(undefined, 'normal');
            doc.text(`Cliente: ${cliente}`, 20, currentY + 7);
            doc.text(`Local da Obra: ${localizacao || 'N√£o informado'}`, 20, currentY + 14);
            doc.text(`Fornecedor: ${fornecedor}`, 110, currentY + 7);
            doc.text(`Tipo de Vidro: ${tipoVidro}`, 110, currentY + 14);

            currentY += 25;

            // =========================================================================
            // OBSERVA√á√ïES (se houver)
            // =========================================================================
            if (observacoes) {
                doc.setFont(undefined, 'bold');
                doc.text('OBSERVA√á√ïES:', 20, currentY);
                
                doc.setFont(undefined, 'normal');
                const observacoesLines = doc.splitTextToSize(observacoes, 170);
                doc.text(observacoesLines, 20, currentY + 7);
                
                currentY += 10 + (observacoesLines.length * 5);
            }

            // =========================================================================
            // LISTA DE VIDROS COM IMAGENS
            // =========================================================================
            
            // T√≠tulo da se√ß√£o
            doc.setFont(undefined, 'bold');
            doc.setTextColor(...corPrimaria);
            doc.text('RELAT√ìRIO DE VIDROS PARA TEMPERA', 105, currentY + 5, { align: 'center' });
            currentY += 15;

            // Agrupa vidros por produto para melhor organiza√ß√£o
            const vidrosPorProduto = {};
            vidrosCalculados.forEach(vidro => {
                if (!vidrosPorProduto[vidro.produtoNome]) {
                    vidrosPorProduto[vidro.produtoNome] = [];
                }
                vidrosPorProduto[vidro.produtoNome].push(vidro);
            });

            // Fun√ß√£o para adicionar imagem ao PDF
            const adicionarImagemAoPDF = async (doc, urlImagem, x, y, width = 15, height = 15) => {
                if (!urlImagem) return false;
                
                try {
                    const response = await fetch(urlImagem);
                    const blob = await response.blob();
                    const reader = new FileReader();
                    
                    return new Promise((resolve) => {
                        reader.onload = function() {
                            try {
                                doc.addImage(reader.result, 'JPEG', x, y, width, height);
                                resolve(true);
                            } catch (error) {
                                console.warn('‚ùå Erro ao adicionar imagem (tentando como PNG):', error);
                                try {
                                    doc.addImage(reader.result, 'PNG', x, y, width, height);
                                    resolve(true);
                                } catch (e2) {
                                    console.error('‚ùå Falha ao adicionar imagem:', e2);
                                    resolve(false);
                                }
                            }
                        };
                        reader.readAsDataURL(blob);
                    });
                } catch (error) {
                    console.warn('‚ùå Erro ao carregar imagem (fetch):', error);
                    return false;
                }
            };

            // Processa cada produto e seus vidros
            for (const [produtoNome, vidros] of Object.entries(vidrosPorProduto)) {
                // Verifica se precisa de nova p√°gina
                if (currentY > 250) {
                    doc.addPage();
                    currentY = 40;
                    
                    // Cabe√ßalho das p√°ginas subsequentes
                    doc.setFillColor(...corPrimaria);
                    doc.rect(0, 0, 210, 20, 'F');
                    doc.setFontSize(10);
                    doc.setTextColor(255, 255, 255);
                    doc.text('OFICINA DA FAM√çLIA - Pedido de Vidros para Tempera', 105, 12, { align: 'center' });
                    doc.setTextColor(200, 200, 200);
                    doc.text(`Cliente: ${cliente} | P√°gina ${doc.internal.getNumberOfPages()}`, 105, 18, { align: 'center' });
                }

                // Cabe√ßalho do produto
                doc.setFontSize(12);
                doc.setTextColor(...corPrimaria);
                doc.setFont(undefined, 'bold');
                doc.text(`Produto: ${produtoNome}`, 20, currentY);
                
                // Linha sob o t√≠tulo do produto
                doc.setDrawColor(...corSecundaria);
                doc.line(20, currentY + 2, 80, currentY + 2);
                
                currentY += 10;

                // Para cada vidro do produto
                for (const vidro of vidros) {
                    // Verifica se precisa de nova p√°gina ANTES de desenhar
                    if (currentY > 270) {
                        doc.addPage();
                        currentY = 40;
                        
                        // Cabe√ßalho das p√°ginas subsequentes
                        doc.setFillColor(...corPrimaria);
                        doc.rect(0, 0, 210, 20, 'F');
                        doc.setFontSize(10);
                        doc.setTextColor(255, 255, 255);
                        doc.text('OFICINA DA FAM√çLIA - Pedido de Vidros para Tempera', 105, 12, { align: 'center' });
                        doc.setTextColor(200, 200, 200);
                        doc.text(`Cliente: ${cliente} | P√°gina ${doc.internal.getNumberOfPages()}`, 105, 18, { align: 'center' });
                    }
                    
                    const itemHeight = 35;
                    const imageWidth = 25;
                    const imageHeight = 25;
                    const imageStartX = 20;
                    const textStartX = imageStartX + imageWidth + 5;
                    
                    let linhaY = currentY;

                    let imagemAdicionada = false;
                    if (vidro.url_imagem_peca) {
                        imagemAdicionada = await adicionarImagemAoPDF(doc, vidro.url_imagem_peca, imageStartX, linhaY, imageWidth, imageHeight);
                    }

                    // Texto das informa√ß√µes do vidro
                    const textoX = imagemAdicionada ? textStartX : imageStartX;
                    
                    doc.setFontSize(9);
                    doc.setTextColor(0, 0, 0);
                    
                    // Nome da pe√ßa COM A COR DO VIDRO
                    doc.setFont(undefined, 'bold');
                    const textoPeca = vidro.corVidro !== 'Padr√£o' ? 
                        `${vidro.pecaNome} (${vidro.tipoVidro} ${vidro.corVidro})` : 
                        vidro.pecaNome;
                    doc.text(textoPeca, textoX, linhaY + 5);
                    
                    // Medidas e quantidade
                    doc.setFont(undefined, 'normal');
                    doc.text(`Medidas: ${vidro.larguraVidro.toFixed(3)}m √ó ${vidro.alturaVidro.toFixed(3)}m`, textoX, linhaY + 10);
                    doc.text(`Quantidade: ${vidro.quantidadeTotal} un. | √Årea: ${vidro.areaTotal.toFixed(3)}m¬≤`, textoX, linhaY + 15);
                    
                    // F√≥rmula
                    doc.setTextColor(100, 100, 100);
                    doc.text(`F√≥rmula: ${vidro.formulaLargura} √ó ${vidro.formulaAltura}`, textoX, linhaY + 20);
                    
                    // Incrementa Y
                    currentY += itemHeight;
                    
                    // Linha divis√≥ria entre vidros
                    doc.setDrawColor(240, 240, 240);
                    doc.line(20, currentY - 2, 190, currentY - 2);
                }
                
                // Espa√ßo entre produtos
                currentY += 5;
            }

            // =========================================================================
            // RESUMO FINAL
            // =========================================================================
            if (currentY > 220) {
                doc.addPage();
                currentY = 40;
                
                // Cabe√ßalho das p√°ginas subsequentes
                doc.setFillColor(...corPrimaria);
                doc.rect(0, 0, 210, 20, 'F');
                doc.setFontSize(10);
                doc.setTextColor(255, 255, 255);
                doc.text('OFICINA DA FAM√çLIA - Pedido de Vidros para Tempera', 105, 12, { align: 'center' });
                doc.setTextColor(200, 200, 200);
                doc.text(`Cliente: ${cliente} | P√°gina ${doc.internal.getNumberOfPages()}`, 105, 18, { align: 'center' });
            }

            const areaTotal = vidrosCalculados.reduce((sum, v) => sum + v.areaTotal, 0);
            const totalVidros = vidrosCalculados.reduce((sum, v) => sum + v.quantidadeTotal, 0);
            
            // Linha divis√≥ria antes do total
            doc.setDrawColor(...corSecundaria);
            doc.line(20, currentY, 190, currentY);
            currentY += 10;
            
            // Resumo geral
            doc.setFillColor(245, 245, 245);
            doc.rect(20, currentY, 170, 25, 'F');
            
            doc.setFontSize(12);
            doc.setTextColor(...corPrimaria);
            doc.setFont(undefined, 'bold');
            doc.text('RESUMO GERAL DO PEDIDO', 105, currentY + 8, { align: 'center' });
            
            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);
            doc.text(`Total de Vidros: ${totalVidros} unidades`, 40, currentY + 17);
            doc.text(`√Årea Total: ${areaTotal.toFixed(3)} m¬≤`, 130, currentY + 17);

            currentY += 35;

            // =========================================================================
            // RODAP√â PROFISSIONAL
            // =========================================================================
            doc.setFontSize(8);
            doc.setTextColor(100, 100, 100);
            doc.text(`Documento gerado em: ${new Date().toLocaleString('pt-BR')} ‚Ä¢ Oficina da Fam√≠lia - Sistema Especializado`, 105, 290, { align: 'center' });
            doc.text('Rua Elias Calisto, 669 - Ipiranga - PR - CEP: 84450-000 ‚Ä¢ Tel: (42) 99960-8330', 105, 293, { align: 'center' });

            // =========================================================================
            // SALVAR PDF
            // =========================================================================
            const nomeArquivo = `Pedido_Tempera_${cliente.replace(/[^a-zA-Z0-9]/g, '_')}_${dataPedido.replace(/\//g, '-')}.pdf`;
            doc.save(nomeArquivo);
        }

        function gerarPlanilha() {
            if (vidrosCalculados.length === 0) {
                alert('‚ùå Calcule os vidros primeiro');
                return;
            }
            
            let csv = 'Produto,Pe√ßa,F√≥rmula Largura,F√≥rmula Altura,Largura Vidro (m),Altura Vidro (m),Quantidade,√Årea Total (m¬≤),URL Imagem\n';
            
            vidrosCalculados.forEach(vidro => {
                const imgInfo = (vidro.url_imagem_peca && vidro.url_imagem_peca.startsWith('data:image')) ? 'Imagem Base64 (no DB)' : (vidro.url_imagem_peca || '');
                csv += `"${vidro.produtoNome}","${vidro.pecaNome}","${vidro.formulaLargura}","${vidro.formulaAltura}",${vidro.larguraVidro.toFixed(3)},${vidro.alturaVidro.toFixed(3)},${vidro.quantidadeTotal},${vidro.areaTotal.toFixed(3)},"${imgInfo}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `vidros_tempera_${document.getElementById('clienteObra').value.replace(/ /g, '_')}_${new Date().toLocaleDateString('pt-BR').replace(/\//g, '-')}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // =============================================================================
        // UTILIT√ÅRIOS
        // =============================================================================
        function limparPedido() {
            if (!confirm('Limpar todo o pedido atual?')) return;
            
            vidrosCalculados = [];
            formulasPorProduto = {};
            document.getElementById('selecionarObra').value = '';
            document.getElementById('clienteObra').value = '';
            document.getElementById('localizacaoObra').value = '';
            document.getElementById('cardProdutosObra').style.display = 'none';
            document.getElementById('resumoVidros').style.display = 'none';
            alert('‚úÖ Pedido limpo!');
        }
    </script>
</body>
</html>