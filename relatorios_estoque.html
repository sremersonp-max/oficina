<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relat√≥rios de Estoque - Esquadrias</title>
    <link rel="stylesheet" href="styles.css"> 
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        /* Estilos espec√≠ficos para a tabela de relat√≥rios */
        .relatorio-tabela {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .relatorio-tabela th, .relatorio-tabela td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        .relatorio-tabela th {
            background-color: #f2f2f2;
        }
        .estoque-negativo {
            background-color: #fce4e4; /* Cor suave para negativo */
            color: #c0392b;
            font-weight: bold;
        }
        .estoque-baixo {
            background-color: #fef9e7; /* Cor suave para baixo */
            color: #f39c12;
        }
        .estoque-ok {
            /* Padr√£o */
        }

        /* NOVO: Grid de filtros mais robusto */
        .filtros-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            align-items: flex-end; /* Alinha os bot√µes na base */
        }
    </style>
</head>
<body>
    <div class="container">
        
        <div class="card" style="margin-bottom: 25px;">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                <h1>üìä Relat√≥rios de Estoque</h1>
                <div style="display: flex; gap: 10px;">
                    <a href="index.html" class="btn btn-secondary">üè† In√≠cio</a>
                    <a href="estoque.html" class="btn btn-primary">üè≠ Estoque</a>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>Filtros do Relat√≥rio</h2>
            
            <div class="filtros-grid">
                <div class="form-group">
                    <label for="tipoRelatorio">Status do Estoque</label>
                    <select id="tipoRelatorio">
                        <option value="completo">Completo (Todos)</option>
                        <option value="baixo">Estoque Baixo</option>
                        <option value="zerado">Estoque Zerado</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="textoFiltro">Pesquisar (Nome, SKU, Cor)</label>
                    <input type="text" id="textoFiltro" placeholder="Nome, SKU...">
                </div>

                <div class="form-group">
                    <label for="categoriaFiltro">Categoria</label>
                    <select id="categoriaFiltro">
                        <option value="">Todas</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="linhaFiltro">Linha</label>
                    <select id="linhaFiltro">
                        <option value="">Todas</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="corFiltro">Cor</label>
                    <select id="corFiltro">
                        <option value="">Todas</option>
                    </select>
                </div>
            </div>

            <div class="acoes" style="margin-top: 20px; display:flex; gap: 10px;">
                <button class="btn btn-primary" onclick="gerarRelatorio()">üìä Gerar Relat√≥rio</button>
                <button class="btn btn-secondary" onclick="limparFiltros()">üóëÔ∏è Limpar Filtros</button>
            </div>
        </div>

        <div class="card">
            <div class="acoes" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0;" id="tituloResultado">Resultado</h2>
                <button class="btn btn-success" id="btnExportarPDF" onclick="exportarPDF()" disabled>üìÑ Exportar PDF</button>
            </div>
            
            <div id="relatorioContainer">
                <p class="muted">Gere um relat√≥rio usando os filtros acima.</p>
            </div>
            
            <div id="relatorioTotais" class="card" style="margin-top: 20px; background: #f8f9fa; display: none;">
                <h3>Totais do Relat√≥rio</h3>
                <div class="grid grid-3" style="margin-top: 15px;">
                    <div class="form-group">
                        <label>Total de Itens (SKUs)</label>
                        <input type="text" id="totalItens" readonly>
                    </div>
                    <div class="form-group">
                        <label>Valor Total em Estoque (Pre√ßo Venda)</label>
                        <input type="text" id="valorTotalVenda" readonly>
                    </div>
                    <div class="form-group">
                        <label>Valor Total em Estoque (Pre√ßo Custo)</label>
                        <input type="text" id="valorTotalCusto" readonly>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        // Armazena todos os itens carregados para filtragem r√°pida
        let todosOsItens = [];

        document.addEventListener('DOMContentLoaded', async () => {
            await popularSelects();
            
            // Carrega todos os dados na inicializa√ß√£o
            const loadingElement = document.getElementById('relatorioContainer');
            loadingElement.innerHTML = '<p class="loading">Carregando todos os itens do estoque...</p>';
            
            try {
                // A fun√ß√£o carregarItens() vem de config.js e j√° busca todas as varia√ß√µes
                todosOsItens = await estoqueFunctions.carregarItens();
                
                // Gera o relat√≥rio inicial "Completo"
                gerarRelatorio();
            } catch (error) {
                console.error("Erro ao carregar itens:", error);
                loadingElement.innerHTML = '<p class="text-danger">‚ùå Erro ao carregar dados. Verifique o console.</p>';
            }
        });

        // MODIFICADO: Carrega Categorias, Linhas e Cores
        async function popularSelects() {
            try {
                const [categorias, linhas, cores] = await Promise.all([
                    estoqueFunctions.carregarCategorias(),
                    estoqueFunctions.carregarLinhas(),
                    estoqueFunctions.carregarCores()
                ]);

                const catSelect = document.getElementById('categoriaFiltro');
                catSelect.innerHTML = '<option value="">Todas</option>' + 
                    categorias.map(c => `<option value="${c.id}">${c.nome}</option>`).join('');
                
                const linhaSelect = document.getElementById('linhaFiltro');
                linhaSelect.innerHTML = '<option value="">Todas</option>' + 
                    linhas.map(l => `<option value="${l.id}">${l.nome}</option>`).join('');

                const corSelect = document.getElementById('corFiltro');
                corSelect.innerHTML = '<option value="">Todas</option>' + 
                    cores.map(c => `<option value="${c.id}">${c.nome}</option>`).join('');

            } catch (error) {
                console.error("Erro ao popular selects:", error);
                alert('Erro ao carregar filtros. Verifique o console.');
            }
        }

        // NOVO: Fun√ß√£o para limpar todos os filtros
        function limparFiltros() {
            document.getElementById('tipoRelatorio').value = 'completo';
            document.getElementById('textoFiltro').value = '';
            document.getElementById('categoriaFiltro').value = '';
            document.getElementById('linhaFiltro').value = '';
            document.getElementById('corFiltro').value = '';
            
            gerarRelatorio(); // Gera o relat√≥rio com os filtros limpos
        }

        // MODIFICADO: Apenas chama a fun√ß√£o de filtragem e renderiza√ß√£o
        function gerarRelatorio() {
            const tipoRelatorio = document.getElementById('tipoRelatorio').value;
            const categoriaFiltro = document.getElementById('categoriaFiltro').value;
            const linhaFiltro = document.getElementById('linhaFiltro').value;
            const corFiltro = document.getElementById('corFiltro').value;
            const textoFiltro = document.getElementById('textoFiltro').value;

            // Filtra os dados localmente
            const dadosFiltrados = filtrarDados(
                todosOsItens, 
                tipoRelatorio, 
                categoriaFiltro, 
                linhaFiltro, 
                corFiltro, 
                textoFiltro
            );
            
            // Renderiza a tabela com os dados filtrados
            renderizarTabela(dadosFiltrados, tipoRelatorio);
        }

        // NOVO: Fun√ß√£o central de filtragem
        function filtrarDados(itens, tipo, categoriaId, linhaId, corId, texto) {
            const textoBusca = texto.toLowerCase().trim();

            return itens.filter(item => {
                // Filtro de Texto (Nome, SKU, Cor)
                if (textoBusca) {
                    const nomeMatch = item.nome_base.toLowerCase().includes(textoBusca);
                    // Garante que sku n√£o seja nulo antes de chamar toLowerCase()
                    const skuMatch = item.sku && item.sku.toLowerCase().includes(textoBusca);
                    const corMatch = item.cor.toLowerCase().includes(textoBusca);
                    
                    if (!nomeMatch && !skuMatch && !corMatch) {
                        return false;
                    }
                }
                
                // Filtro Categoria (compara com item.categoria_id)
                if (categoriaId && item.categoria_id != categoriaId) {
                    return false;
                }

                // Filtro Linha (compara com item.linha_id)
                if (linhaId && item.linha_id != linhaId) {
                    return false;
                }

                // Filtro Cor (compara com item.cor_id)
                if (corId && item.cor_id != corId) {
                    return false;
                }

                // Filtro de Status (Tipo Relat√≥rio)
                if (tipo === 'baixo') {
                    // L√≥gica original (item.itens?.quantidade_minima n√£o vem de config.js, ent√£o usar√° 0)
                    // Esta l√≥gica provavelmente filtra itens com estoque > 0 e <= 0, ou seja, nenhum item.
                    // Para funcionar, config.js -> carregarItens() precisaria ser ajustado.
                    // Mantendo a l√≥gica do arquivo original:
                    const qtdMinima = item.itens?.quantidade_minima || 0; 
                    if (item.quantidade_estoque <= 0 || item.quantidade_estoque > qtdMinima) {
                         return false;
                    }

                } else if (tipo === 'zerado') {
                    if (item.quantidade_estoque > 0) {
                        return false;
                    }
                }
                
                // Se passou por tudo
                return true;
            });
        }


        // Fun√ß√£o para renderizar a tabela (sem modifica√ß√µes de l√≥gica, apenas de nome de var)
        function renderizarTabela(dados, tipoRelatorio) {
            const container = document.getElementById('relatorioContainer');
            const totaisContainer = document.getElementById('relatorioTotais');
            const btnPDF = document.getElementById('btnExportarPDF');
            
            // Atualiza o t√≠tulo
            const tipoTexto = document.getElementById('tipoRelatorio').options[document.getElementById('tipoRelatorio').selectedIndex].text;
            document.getElementById('tituloResultado').textContent = `Resultado: ${tipoTexto}`;

            if (!dados || dados.length === 0) {
                container.innerHTML = '<p class="muted">Nenhum item encontrado com os filtros aplicados.</p>';
                totaisContainer.style.display = 'none';
                btnPDF.disabled = true;
                return;
            }

            let valorTotalVenda = 0;
            let valorTotalCusto = 0; // Este campo n√£o existe nos dados, ser√° sempre 0

            let tabelaHtml = `
                <table class="relatorio-tabela" id="tabelaRelatorio">
                    <thead>
                        <tr>
                            <th>Item (Modelo)</th>
                            <th>Cor</th>
                            <th>SKU</th>
                            <th>Un.</th>
                            <th>Pre√ßo Venda (R$)</th>
                            <th>Estoque Atual</th>
                            <th>Valor em Estoque (R$)</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            for (const item of dados) {
                const qtd = item.quantidade_estoque || 0;
                const precoVenda = item.preco_venda || 0;
                const valorEstoque = qtd * precoVenda;
                valorTotalVenda += valorEstoque;
                
                // OBS: 'item.itens.preco_custo' n√£o √© carregado pela fun√ß√£o carregarItens()
                const precoCusto = item.itens?.preco_custo || 0; 
                valorTotalCusto += qtd * precoCusto;

                // Define a classe CSS com base no status do estoque
                let classeEstoque = 'estoque-ok';
                const qtdMinima = item.itens?.quantidade_minima || 0;

                if (qtd <= 0) {
                    classeEstoque = 'estoque-negativo';
                } else if (qtd > 0 && qtd <= qtdMinima) {
                    classeEstoque = 'estoque-baixo';
                }

                tabelaHtml += `
                    <tr class="${classeEstoque}">
                        <td>${item.nome_base || 'N/A'}</td>
                        <td>${item.cor || 'N/A'}</td>
                        <td>${item.sku || 'N/A'}</td>
                        <td>${item.unidade_medida || 'N/A'}</td>
                        <td>${precoVenda.toFixed(2)}</td>
                        <td><strong>${qtd}</strong></td>
                        <td>${valorEstoque.toFixed(2)}</td>
                    </tr>
                `;
            }

            tabelaHtml += `
                    </tbody>
                </table>
            `;
            
            container.innerHTML = tabelaHtml;
            
            // Atualiza e exibe os totais
            document.getElementById('totalItens').value = dados.length;
            document.getElementById('valorTotalVenda').value = `R$ ${valorTotalVenda.toFixed(2)}`;
            document.getElementById('valorTotalCusto').value = `R$ ${valorTotalCusto.toFixed(2)}`;
            totaisContainer.style.display = 'block';
            btnPDF.disabled = false;
        }


        // =============================================================================
        // FUN√á√ÉO DE EXPORTAR PDF (Sem altera√ß√µes)
        // =============================================================================
        async function exportarPDF() {
            const btn = document.getElementById('btnExportarPDF');
            btn.textContent = 'Gerando...';
            btn.disabled = true;

            const { jsPDF } = window.jspdf;
            const tabela = document.getElementById('tabelaRelatorio');
            
            if (!tabela) {
                alert('‚ùå Tabela n√£o encontrada para exportar.');
                btn.textContent = 'üìÑ Exportar PDF';
                btn.disabled = false;
                return;
            }

            try {
                // Usa html2canvas para capturar a tabela como imagem
                const canvas = await html2canvas(tabela, {
                    scale: 2, // Aumenta a resolu√ß√£o
                    useCORS: true
                });
                
                const imgData = canvas.toDataURL('image/png');
                
                const doc = new jsPDF({
                    orientation: 'landscape',
                    unit: 'mm',
                    format: 'a4'
                });

                const pageHeight = doc.internal.pageSize.getHeight();
                const pageWidth = doc.internal.pageSize.getWidth();
                
                const imgWidth = pageWidth - 20; // Margens (10mm de cada lado)
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                
                let heightLeft = imgHeight;
                let position = 25; // Posi√ß√£o inicial com margem superior

                // --- Adiciona Cabe√ßalho ---
                doc.setFontSize(18);
                doc.setFont(undefined, 'bold');
                doc.text("Oficina da Familia - Relat√≥rio de Estoque", pageWidth / 2, 15, { align: 'center' });
                
                doc.setFontSize(12);
                doc.setFont(undefined, 'normal');
                const tipoRelatorio = document.getElementById('tipoRelatorio').options[document.getElementById('tipoRelatorio').selectedIndex].text;
                doc.text(`Tipo de Relat√≥rio: ${tipoRelatorio}`, 10, position);
                
                doc.setFontSize(10);
                doc.text(`Filtro Categoria: ${document.getElementById('categoriaFiltro').options[document.getElementById('categoriaFiltro').selectedIndex].text}`, 10, position + 7);
                doc.text(`Data: ${new Date().toLocaleDateString()}`, 10, position + 14);
                position += 25; // Incrementa a posi√ß√£o para baixo do cabe√ßalho

                // Adiciona a imagem do HTML
                doc.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
                heightLeft -= (pageHeight - position);

                // L√≥gica para m√∫ltiplas p√°ginas
                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight + 10;
                    doc.addPage();
                    doc.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
                    heightLeft -= (pageHeight - 20);
                }
                
                // Salva o arquivo
                doc.save(`relatorio-estoque-${tipoRelatorio.toLowerCase().replace(/\s/g, '-')}-${new Date().getTime()}.pdf`);
                
                alert('‚úÖ PDF gerado com sucesso!');

            } catch (e) {
                console.error('Erro ao gerar PDF:', e);
                alert('‚ùå Erro ao gerar o PDF. Verifique o console para mais detalhes.');
            } finally {
                // Restaura o bot√£o
                btn.textContent = 'üìÑ Exportar PDF';
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>